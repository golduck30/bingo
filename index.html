<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìƒˆ ì±„íŒ…</title> 
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        /* Gemini í…Œë§ˆ ì ìš© */
        :root {
            --gemini-bg: #ffffff;
            --gemini-sidebar: #f0f4f9;
            --gemini-text: #1f1f1f;
            --gemini-subtext: #444746;
            --gemini-blue: #1a73e8;
            --gemini-light-blue: #e8f0fe;
            --gemini-border: #e0e3e7;
            --gemini-hover: #f5f8fc;
        }

        body { font-family: 'Google Sans', 'Malgun Gothic', sans-serif; background-color: var(--gemini-bg); color: var(--gemini-text); margin: 0; padding: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        .app-container { width: 100%; max-width: 900px; display: flex; flex-direction: column; height: 100%; }
        
        /* ìƒë‹¨ í—¤ë” (ìœ„ì¥ìš©) */
        .fake-header { padding: 15px 20px; display: flex; align-items: center; border-bottom: 1px solid var(--gemini-border); color: var(--gemini-subtext); font-size: 1.1rem; }
        .fake-header span { margin-left: 10px; font-weight: 500; }

        .main-content { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background-color: transparent; padding: 0; width: 100%; max-width: 600px; text-align: left; position: relative; }

        h1, h2 { color: var(--gemini-text); font-weight: 400; margin-bottom: 15px; }
        p { color: var(--gemini-subtext); line-height: 1.5; }

        .btn-primary { background-color: var(--gemini-blue); color: white; border: none; padding: 10px 24px; border-radius: 24px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center;}
        .btn-primary:hover { background-color: #1557b0; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .btn-secondary { background-color: transparent; color: var(--gemini-blue); border: 1px solid var(--gemini-border); padding: 8px 16px; border-radius: 20px; font-weight: 500; cursor: pointer; font-size: 0.9rem; }
        .btn-secondary:hover { background-color: var(--gemini-hover); }

        .login-input, .setup-input, .chat-input { padding: 12px 16px; font-size: 1rem; border: 1px solid var(--gemini-border); border-radius: 24px; width: 100%; box-sizing: border-box; outline: none; transition: 0.2s; background: var(--gemini-bg); color: var(--gemini-text);}
        .login-input:focus, .setup-input:focus, .chat-input:focus { border-color: var(--gemini-blue); background-color: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }

        #loginScreen, #setupScreen, #waitingScreen, #mainBoard { display: none; flex-direction: column; width: 100%; }
        #loginScreen { display: flex; }

        .subject-box { background: var(--gemini-hover); color: var(--gemini-text); padding: 15px; border-radius: 12px; margin: 15px 0; border: 1px solid var(--gemini-border); display: flex; align-items: center; }
        .setup-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; width: 100%; margin: 20px 0; }
        .setup-input { border-radius: 8px; text-align: center; padding: 5px; font-size: 0.9rem; }

        .wait-list { background: var(--gemini-bg); border: 1px solid var(--gemini-border); border-radius: 12px; padding: 15px; width: 100%; margin-bottom: 20px; }
        .wait-item { padding: 10px; border-bottom: 1px solid var(--gemini-border); color: var(--gemini-text); display: flex; align-items: center; }
        .wait-item::before { content: 'â—'; color: var(--gemini-blue); margin-right: 10px; font-size: 0.8rem; }

        .broadcaster { background: var(--gemini-hover); color: var(--gemini-text); padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid var(--gemini-blue); display: flex; align-items: flex-start; }
        .turn-alert { background: transparent; color: var(--gemini-subtext); padding: 10px 0; margin-bottom: 10px; font-weight: 500; border-bottom: 1px solid var(--gemini-border); }
        .turn-alert.my-turn { color: var(--gemini-blue); font-weight: bold; }
        .turn-alert.my-turn::before { content: 'âœ¨ '; }

        .leaderboard { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .player-badge { background: var(--gemini-sidebar); border: 1px solid var(--gemini-border); padding: 4px 12px; border-radius: 16px; font-size: 0.85rem; color: var(--gemini-subtext); }
        .player-badge.active-turn { background: var(--gemini-light-blue); color: var(--gemini-blue); border-color: var(--gemini-blue); font-weight: 600; }

        .bingo-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1px; background: var(--gemini-border); border: 1px solid var(--gemini-border); border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        .bingo-cell { background-color: var(--gemini-bg); aspect-ratio: 1 / 1; display: flex; justify-content: center; align-items: center; padding: 4px; font-size: 0.85rem; color: var(--gemini-text); cursor: pointer; user-select: none; transition: 0.2s; word-break: break-word; position: relative; text-align: center; }
        .bingo-cell:hover { background-color: var(--gemini-hover); }
        
        @keyframes shake-not-turn { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-3px); background: #fff0f0; } 75% { transform: translateX(3px); background: #fff0f0; } }
        .bingo-cell.shake-it { animation: shake-not-turn 0.3s; cursor: not-allowed; color: #d93025; }

        .bingo-cell.stamped { background-color: var(--gemini-light-blue); color: var(--gemini-blue); font-weight: 600; }
        .bingo-cell.stamped::after { content: 'âœ“'; position: absolute; top: 2px; right: 4px; font-size: 1rem; color: var(--gemini-blue); opacity: 0.7; }

        .chat-container { border-top: 1px solid var(--gemini-border); padding-top: 20px; display: flex; flex-direction: column; height: 300px; }
        .chat-messages { flex: 1; overflow-y: auto; padding-right: 5px; display: flex; flex-direction: column; gap: 15px; }
        .chat-msg { display: flex; flex-direction: column; max-width: 85%; }
        .chat-msg.mine { align-self: flex-end; align-items: flex-end; }
        .chat-sender { font-size: 0.8rem; color: var(--gemini-subtext); margin-bottom: 4px; }
        .chat-bubble { background: var(--gemini-sidebar); padding: 10px 15px; border-radius: 18px; border-top-left-radius: 4px; color: var(--gemini-text); line-height: 1.4; }
        .chat-msg.mine .chat-bubble { background: var(--gemini-light-blue); color: var(--gemini-text); border-radius: 18px; border-top-right-radius: 4px; }
        .chat-msg.system { align-self: center; background: transparent; color: var(--gemini-subtext); font-size: 0.85rem; text-align: center; margin: 10px 0; }
        
        .chat-input-row { display: flex; gap: 10px; margin-top: 15px; align-items: center; background: var(--gemini-bg); padding: 5px; border-radius: 30px; border: 1px solid var(--gemini-border); }
        .chat-input { border: none; padding: 10px 15px; flex: 1; border-radius: 0; background: transparent; }
        .chat-input:focus { box-shadow: none; }
        .btn-send { background: transparent; border: none; color: var(--gemini-blue); cursor: pointer; padding: 10px; display: flex; align-items: center; }
        
        #winnerOverlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); color: var(--gemini-text); flex-direction: column; align-items: center; justify-content: center; z-index: 10; padding: 20px; box-sizing: border-box; backdrop-filter: blur(5px); }
        .winner-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1px; background: var(--gemini-border); border: 1px solid var(--gemini-border); width: 100%; max-width: 400px; margin: 20px 0; }
        .w-cell { background: var(--gemini-bg); aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; padding: 2px; text-align: center; }
        .w-cell.stamped { background: var(--gemini-light-blue); color: var(--gemini-blue); font-weight: bold; }

        @media (max-width: 500px) { .setup-input, .bingo-cell { font-size: 0.75rem; } }
    </style>
</head>
<body>

<div class="app-container">
    <div class="fake-header">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z" fill="#1a73e8"/></svg>
        <span>Gemini Advanced (ì—…ë¬´ ë³´ì¡°)</span>
    </div>

    <div class="main-content">
        <div class="container" id="loginScreen">
            <h1>ì•ˆë…•í•˜ì„¸ìš”, <br>ì˜¤ëŠ˜ì˜ ì—…ë¬´ í˜‘ì—… ì„¸ì…˜ì„ ì‹œì‘í•©ë‹ˆë‹¤.</h1>
            <p>ì°¸ì—¬ë¥¼ ìœ„í•´ ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            
            <div class="subject-box">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="#444746" style="margin-right:10px;"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                í˜„ì¬ ì„¸ì…˜ ì£¼ì œ: <strong id="loginSubjectText" style="margin-left: 5px; color: var(--gemini-blue);">ë°ì´í„° ì—°ê²° ì¤‘...</strong>
            </div>
            <button class="btn-secondary" style="margin-bottom: 25px; width: fit-content;" onclick="pickRandomTopic()">ì£¼ì œ ìƒˆë¡œê³ ì¹¨</button>

            <div style="display: flex; gap: 10px; width: 100%;">
                <input type="text" id="playerName" class="login-input" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" required autocomplete="off" onkeypress="if(event.key==='Enter') enterSetup()">
                <button class="btn-primary" onclick="enterSetup()">ì„¸ì…˜ ì°¸ì—¬</button>
            </div>
        </div>

        <div class="container" id="setupScreen">
            <h2>ë°ì´í„° ì…ë ¥ ë‹¨ê³„</h2>
            <p>ì£¼ì œì— ë§ëŠ” í‚¤ì›Œë“œ 25ê°œë¥¼ ì…ë ¥í•˜ì—¬ ë°ì´í„°ì…‹ì„ êµ¬ì„±í•´ì£¼ì„¸ìš”.<br>ì£¼ì œ: <strong id="setupSubjectText" style="color: var(--gemini-blue);"></strong></p>
            
            <div class="setup-grid" id="setupGrid"></div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                <button onclick="fillTestNumbers()" style="background: transparent; border: none; color: var(--gemini-subtext); cursor: pointer; font-size: 0.9rem;">(í…ŒìŠ¤íŠ¸ ë°ì´í„° ìë™ ì…ë ¥)</button>
                <button class="btn-primary" onclick="submitBoard()">ì…ë ¥ ì™„ë£Œ</button>
            </div>
        </div>

        <div class="container" id="waitingScreen">
            <h2>ì°¸ì—¬ì ëŒ€ê¸° ì¤‘</h2>
            <p>ëª¨ë“  ì°¸ì—¬ìê°€ ë°ì´í„° ì…ë ¥ì„ ì™„ë£Œí•˜ë©´ ì„¸ì…˜ì´ ì‹œì‘ë©ë‹ˆë‹¤.<br>ì…ë ¥ ì™„ë£Œ ìˆœì„œëŒ€ë¡œ ë°œì–¸ê¶Œ(í„´)ì´ ë¶€ì—¬ë©ë‹ˆë‹¤.</p>
            
            <div class="wait-list" id="readyPlayerList"></div>

            <button class="btn-primary" style="width: 100%;" onclick="startGame()">ëª¨ë“  ì°¸ì—¬ì ì¤€ë¹„ ì™„ë£Œ, ì„¸ì…˜ ì‹œì‘</button>
        </div>

        <div class="container" id="mainBoard">
            
            <div id="winnerOverlay">
                <h2 style="color: var(--gemini-blue);">ğŸ‰ ì„¸ì…˜ ëª©í‘œ ë‹¬ì„±!</h2>
                <p><strong id="winnerNameDisplay">ëˆ„êµ°ê°€</strong>ë‹˜ì´ ê°€ì¥ ë¨¼ì € ë°ì´í„°ë¥¼ ì™„ì„±í–ˆìŠµë‹ˆë‹¤.</p>
                <div class="winner-grid" id="winnerGrid"></div>
                <button class="btn-secondary" style="margin-top: 25px;" onclick="resetAllGame()">ìƒˆ ì„¸ì…˜ ì‹œì‘</button>
            </div>

            <div id="turnAlertBox" class="turn-alert">ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ ì¤‘...</div>
            <div class="broadcaster">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="#1a73e8" style="margin-right: 10px; min-width: 24px;"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
                <div id="broadcasterDisplay">ìµœê·¼ ê³µìœ ëœ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>

            <div class="leaderboard" id="playerList"></div>
            
            <div style="display:flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 10px;">
                <span style="font-weight: 500; color: var(--gemini-blue);" id="myStatusText">ë‚´ ì§„í–‰ë„: 0%</span>
                <button class="btn-secondary" onclick="resetAllGame()" style="font-size:0.8rem; padding: 4px 10px;">ì„¸ì…˜ ì´ˆê¸°í™”</button>
            </div>

            <div class="bingo-grid" id="bingoGrid"></div>

            <div class="chat-container">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-row">
                    <input type="text" id="chatInput" class="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥..." onkeypress="if(event.key==='Enter') sendChat()">
                    <button class="btn-send" onclick="sendChat()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ğŸ’¡ 1. ì•—! ë¹ ì ¸ìˆë˜ databaseURL í•œ ì¤„ì„ ë‹¤ì‹œ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.
    const firebaseConfig = {
        apiKey: "AIzaSyBZmxJUr5oaZttF7oIYJSEBb5RgjVQjInY",
        authDomain: "cofirm-board.firebaseapp.com",
        databaseURL: "https://cofirm-board-default-rtdb.firebaseio.com", // ğŸ‘ˆ ë°”ë¡œ ì´ ë…€ì„!
        projectId: "cofirm-board",
        storageBucket: "cofirm-board.firebasestorage.app",
        messagingSenderId: "367825644618",
        appId: "1:367825644618:web:3f236c72c07d5347878ab3",
        measurementId: "G-N4QY18DHPX"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // ğŸ’¡ 2. ê¸°ì¡´ ë°ì´í„° ì£¼ì†Œ ê·¸ëŒ€ë¡œ ì‚¬ìš©! (turn_bingo ê²½ë¡œ ìœ ì§€)
    const gameRef = db.ref('turn_bingo'); 
    const chatRef = db.ref('turn_bingo/chat');
    
    let myName = ""; 
    let myBoardRef = null;
    let turnOrderList = [];
    let currentTurnPlayer = "";

    // ğŸ’¡ ì£¼ì œ ë£°ë › (ì¬ë°ŒëŠ” ì¼ë°˜ ì£¼ì œë“¤ë¡œ êµ¬ì„±)
    const topicList = ["ì˜í™” ì œëª© (í•œêµ­/ì™¸êµ­)", "ë‚˜ë¼ ì´ë¦„", "ë“œë¼ë§ˆ ì œëª©", "ë™ë¬¼ ì´ë¦„", "ê³¼ì¼ê³¼ ì±„ì†Œ", "ìœ ëª… ì—°ì˜ˆì¸ ì´ë¦„", "ìœ ëª…í•œ ë…¸ë˜ ì œëª©", "ìŒì‹/ìš”ë¦¬ ì´ë¦„", "ìŠ¤í¬ì¸  ì¢…ëª©", "ì•„ì´ìŠ¤í¬ë¦¼ ì´ë¦„", "ê²Œì„ ì´ë¦„"];
    
    function pickRandomTopic() {
        gameRef.child('subject').set(topicList[Math.floor(Math.random() * topicList.length)]);
    }
    
    gameRef.child('subject').on('value', (snap) => {
        // ê¸°ì¡´ ë°©ì— ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë¶ˆëŸ¬ì˜¤ê³ , ì—†ìœ¼ë©´ ì²« ì£¼ì œë¥¼ ê³ ì •
        const sub = snap.val() || "ì˜í™” ì œëª© (í•œêµ­/ì™¸êµ­)";
        document.getElementById('loginSubjectText').innerText = sub;
        document.getElementById('setupSubjectText').innerText = sub;
    });

    // ì‘ì„± í™”ë©´ ì§„ì…
    function enterSetup() {
        const val = document.getElementById('playerName').value.trim();
        if(!val) { alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
        myName = val;
        myBoardRef = gameRef.child('players').child(myName);

        myBoardRef.once('value', (snap) => {
            const data = snap.val();
            if (data && data.ready) {
                gameRef.child('state').once('value', stateSnap => {
                    if(stateSnap.val() && stateSnap.val().isStarted) {
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('mainBoard').style.display = 'flex';
                        startMainGameListeners();
                    } else {
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('waitingScreen').style.display = 'flex';
                        listenToWaitingRoom();
                    }
                });
            } else {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('setupScreen').style.display = 'flex';
                
                const grid = document.getElementById('setupGrid');
                grid.innerHTML = '';
                for(let i=0; i<25; i++) {
                    const input = document.createElement('input');
                    input.type = 'text'; input.className = 'setup-input'; input.id = `input_cell_${i}`;
                    input.onkeypress = (e) => { if(e.key === 'Enter') { const n = document.getElementById(`input_cell_${i+1}`); if(n) n.focus(); } };
                    grid.appendChild(input);
                }
            }
        });
    }

    // ë¹™ê³ íŒ ì œì¶œ
    function submitBoard() {
        const newBoard = {};
        for(let i=0; i<25; i++) {
            const val = document.getElementById(`input_cell_${i}`).value.trim();
            if(!val) { alert(`${i+1}ë²ˆì§¸ ì¹¸ì˜ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.`); return; }
            newBoard[i] = { text: val, stamped: false };
        }
        myBoardRef.set({ ready: true, readyAt: firebase.database.ServerValue.TIMESTAMP, lines: 0, board: newBoard });
        chatRef.push({ type: 'system', msg: `[${myName}]ë‹˜ì´ ë°ì´í„°ì…‹ ì…ë ¥ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.` });
        document.getElementById('setupScreen').style.display = 'none';
        document.getElementById('waitingScreen').style.display = 'flex';
        listenToWaitingRoom();
    }

    // ëŒ€ê¸°ì‹¤
    function listenToWaitingRoom() {
        gameRef.child('players').on('value', (snap) => {
            const players = snap.val();
            const listObj = document.getElementById('readyPlayerList');
            if(!listObj) return;
            listObj.innerHTML = '';
            let sortedPlayers = [];
            for(let key in players) { if(players[key].ready) sortedPlayers.push({ name: key, time: players[key].readyAt }); }
            sortedPlayers.sort((a,b) => a.time - b.time);
            sortedPlayers.forEach((p, idx) => {
                const div = document.createElement('div');
                div.className = 'wait-item';
                div.innerText = `${idx + 1}ìˆœìœ„: ${p.name}`;
                listObj.appendChild(div);
            });
        });
        gameRef.child('state').on('value', (snap) => {
            if(snap.val() && snap.val().isStarted) {
                document.getElementById('waitingScreen').style.display = 'none';
                document.getElementById('mainBoard').style.display = 'flex';
                gameRef.child('players').off(); 
                startMainGameListeners();
            }
        });
    }

    function startGame() {
        gameRef.child('players').once('value', (snap) => {
            const players = snap.val();
            let sortedNames = [];
            for(let key in players) { if(players[key].ready) sortedNames.push({ name: key, time: players[key].readyAt }); }
            sortedNames.sort((a,b) => a.time - b.time);
            const turnOrder = sortedNames.map(p => p.name);
            if(turnOrder.length < 1) return alert("ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤.");
            gameRef.child('state').set({ isStarted: true, turnOrder: turnOrder, turnIndex: 0, lastCalledWord: "", lastCaller: "" });
            chatRef.push({ type: 'system', msg: `ì„¸ì…˜ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ì²« ë°œì–¸ìëŠ” [${turnOrder[0]}]ë‹˜ì…ë‹ˆë‹¤.` });
        });
    }

    // ë©”ì¸ ê²Œì„ ë¡œì§
    function startMainGameListeners() {
        // [ë‚´ ë¹™ê³ íŒ ë Œë”ë§ & í´ë¦­ ì²˜ë¦¬] 
        myBoardRef.child('board').on('value', (snapshot) => {
            const data = snapshot.val();
            if(!data) return;
            const gridElement = document.getElementById('bingoGrid');
            gridElement.innerHTML = '';
            let cellArray = [];
            for (let i = 0; i < 25; i++) {
                const cellData = data[i];
                cellArray.push(cellData);
                const cell = document.createElement('div');
                cell.className = cellData.stamped ? 'bingo-cell stamped' : 'bingo-cell';
                cell.innerText = cellData.text;
                
                cell.onclick = () => {
                    // ğŸ”’ ë‚´ í„´ì´ ì•„ë‹ˆë©´ í´ë¦­ ë§‰ê¸°
                    if (currentTurnPlayer !== myName) {
                        cell.classList.add('shake-it');
                        setTimeout(() => cell.classList.remove('shake-it'), 500);
                        return;
                    }

                    const isNowStamped = !cellData.stamped;
                    myBoardRef.child('board').child(i).update({ stamped: isNowStamped });

                    if (isNowStamped) {
                        if(confirm(`'${cellData.text}' í‚¤ì›Œë“œë¥¼ ê³µìœ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê³µìœ  ì‹œ ë‹¤ìŒ ì°¸ì—¬ìë¡œ í„´ì´ ë„˜ì–´ê°‘ë‹ˆë‹¤.)`)) {
                            gameRef.child('state').once('value', snap => {
                                const st = snap.val();
                                const nextIndex = (st.turnIndex + 1) % st.turnOrder.length;
                                gameRef.child('state').update({ lastCalledWord: cellData.text, lastCaller: myName, turnIndex: nextIndex });
                            });
                        } else {
                            myBoardRef.child('board').child(i).update({ stamped: false });
                        }
                    }
                };
                gridElement.appendChild(cell);
            }
            checkMyBingo(cellArray);
        });

        // [í„´ ë° ìƒíƒœ ê°ì‹œ]
        gameRef.child('state').on('value', (snapshot) => {
            const state = snapshot.val();
            if(!state) return;
            turnOrderList = state.turnOrder || [];
            currentTurnPlayer = turnOrderList[state.turnIndex];

            const alertBox = document.getElementById('turnAlertBox');
            if (currentTurnPlayer === myName) {
                alertBox.className = "turn-alert my-turn";
                alertBox.innerText = `í˜„ì¬ ê·€í•˜ì˜ ë°œì–¸ ì°¨ë¡€ì…ë‹ˆë‹¤. í‚¤ì›Œë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.`;
            } else {
                alertBox.className = "turn-alert";
                alertBox.innerText = `í˜„ì¬ ë°œì–¸ì: [ ${currentTurnPlayer} ]ë‹˜`;
            }

            if (state.lastCalledWord) {
                document.getElementById('broadcasterDisplay').innerHTML = `<div><strong>${state.lastCaller}</strong>ë‹˜ì´ ê³µìœ í•œ í‚¤ì›Œë“œ:</div><div style="color:var(--gemini-blue); font-size:1.2rem; margin-top:5px;">'${state.lastCalledWord}'</div>`;
            } else {
                document.getElementById('broadcasterDisplay').innerText = "ìµœê·¼ ê³µìœ ëœ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.";
            }

            if (state.isGameOver) {
                document.getElementById('winnerOverlay').style.display = 'flex';
                document.getElementById('winnerNameDisplay').innerText = state.winnerName;
                gameRef.child('players').child(state.winnerName).child('board').once('value', (bSnap) => {
                    const wBoard = bSnap.val();
                    const wGrid = document.getElementById('winnerGrid'); wGrid.innerHTML = '';
                    if(wBoard) { for(let i=0; i<25; i++) { const d = document.createElement('div'); d.className = wBoard[i].stamped ? 'w-cell stamped' : 'w-cell'; d.innerText = wBoard[i].text; wGrid.appendChild(d); }}
                });
            }
        });

        // [ë¦¬ë”ë³´ë“œ]
        gameRef.child('players').on('value', (snapshot) => {
            const players = snapshot.val();
            const listObj = document.getElementById('playerList'); listObj.innerHTML = '';
            turnOrderList.forEach(pName => {
                if(!players[pName]) return;
                const lines = players[pName].lines || 0;
                const span = document.createElement('span');
                span.className = (pName === currentTurnPlayer) ? "player-badge active-turn" : "player-badge";
                span.innerText = `${pName} (${lines*20}%)`;
                listObj.appendChild(span);
            });
        });
        startChat();
    }

    // ë¹™ê³  ê³„ì‚°ê¸°
    function checkMyBingo(cells) {
        if(cells.length < 25) return;
        let lines = 0;
        for (let r = 0; r < 5; r++) { if (cells[r*5].stamped && cells[r*5+1].stamped && cells[r*5+2].stamped && cells[r*5+3].stamped && cells[r*5+4].stamped) lines++; }
        for (let c = 0; c < 5; c++) { if (cells[c].stamped && cells[c+5].stamped && cells[c+10].stamped && cells[c+15].stamped && cells[c+20].stamped) lines++; }
        if (cells[0].stamped && cells[6].stamped && cells[12].stamped && cells[18].stamped && cells[24].stamped) lines++;
        if (cells[4].stamped && cells[8].stamped && cells[12].stamped && cells[16].stamped && cells[20].stamped) lines++;
        document.getElementById('myStatusText').innerText = `ë‚´ ì§„í–‰ë„: ${lines*20}% ì™„ë£Œ`;
        myBoardRef.update({ lines: lines });
        if (lines >= 5) {
            gameRef.child('state').once('value', snap => {
                const st = snap.val();
                if(!st || !st.isGameOver) {
                    gameRef.child('state').update({ isGameOver: true, winnerName: myName });
                    chatRef.push({ type: 'system', msg: `ì‹œìŠ¤í…œ ì•Œë¦¼: [${myName}]ë‹˜ì´ ëª©í‘œë¥¼ ë‹¬ì„±í•˜ì—¬ ì„¸ì…˜ì´ ì¢…ë£Œë©ë‹ˆë‹¤.` });
                }
            });
        }
    }

    // ì±„íŒ…
    function startChat() {
        const chatBox = document.getElementById('chatMessages');
        chatRef.on('child_added', (snap) => {
            const data = snap.val();
            const div = document.createElement('div');
            if(data.type === 'system') {
                div.className = 'chat-msg system'; div.innerText = data.msg;
            } else {
                div.className = data.sender === myName ? 'chat-msg mine' : 'chat-msg';
                if(data.sender !== myName) {
                    const nameLabel = document.createElement('div'); nameLabel.className = 'chat-sender'; nameLabel.innerText = data.sender; div.appendChild(nameLabel);
                }
                const bubble = document.createElement('div'); bubble.className = 'chat-bubble'; bubble.innerText = data.msg; div.appendChild(bubble);
            }
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        });
    }
    window.sendChat = function() {
        const input = document.getElementById('chatInput'); const txt = input.value.trim();
        if(txt) { chatRef.push({ type: 'user', sender: myName, msg: txt }); input.value = ''; }
    }

    // ì´ˆê¸°í™”
    window.resetAllGame = function() {
        if(!confirm("í˜„ì¬ ì„¸ì…˜ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        gameRef.remove().then(() => { location.reload(); });
    }
    function fillTestNumbers() { for(let i=0; i<25; i++) { document.getElementById(`input_cell_${i}`).value = "ë°ì´í„°_" + (i + 1); }}
</script>
</body>
</html>
