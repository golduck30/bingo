<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í’€íŒŒí‹° ìˆ˜ì œ ë¹™ê³ </title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        body { font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif; background-color: #2b2d42; color: #fff; margin: 0; padding: 10px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; box-sizing: border-box; }
        .container { background-color: #edf2f4; color: #333; padding: 20px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); width: 100%; max-width: 650px; text-align: center; margin-top: 10px; position: relative; overflow: hidden; }
        
        /* ê³µí†µ ë²„íŠ¼ */
        .btn-primary { background-color: #d90429; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary:hover { background-color: #ef233c; transform: translateY(-2px); }
        .btn-secondary { background-color: #8d99ae; color: white; border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* í™”ë©´ ì œì–´ */
        #loginScreen, #setupScreen, #waitingScreen, #mainBoard { display: none; flex-direction: column; align-items: center; justify-content: center; width: 100%; }
        #loginScreen { display: flex; padding: 30px 10px; }

        /* 1. ì…ì¥ & ì‘ì„± í™”ë©´ */
        .login-input { padding: 12px; font-size: 1.1rem; border: 2px solid #ef233c; border-radius: 8px; width: 80%; max-width: 300px; margin-bottom: 20px; text-align: center; }
        .setup-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; width: 100%; max-width: 450px; margin: 15px auto 25px auto; }
        .setup-input { aspect-ratio: 1/1; text-align: center; border: 2px solid #ccc; border-radius: 8px; font-size: 0.85rem; font-weight: bold; padding: 2px; width: 100%; box-sizing: border-box; }
        .setup-input:focus { border-color: #d90429; outline: none; background: #fff0f3; }

        /* 3. ëŒ€ê¸°ì‹¤ */
        .wait-list { background: #fff; border-radius: 12px; padding: 15px; width: 100%; max-width: 450px; margin-bottom: 20px; text-align: left; }
        .wait-item { font-size: 1.1rem; font-weight: bold; margin-bottom: 8px; color: #2b2d42; border-bottom: 1px dashed #ccc; padding-bottom: 5px; }

        /* 4. ë©”ì¸ ê²Œì„ (í„´ & ë¹™ê³ íŒ) */
        .broadcaster { background: #ffb703; color: #000; font-size: 1.2rem; font-weight: 900; padding: 15px; border-radius: 12px; margin-bottom: 15px; width: 100%; box-sizing: border-box; box-shadow: 0 4px 6px rgba(0,0,0,0.1); word-break: keep-all; }
        .turn-alert { background: #8d99ae; color: #fff; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-weight: bold; width: 100%; box-sizing: border-box; font-size: 1.1rem; transition: 0.3s; }
        .turn-alert.my-turn { background: #d90429; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); box-shadow: 0 0 15px #d90429; } 100% { transform: scale(1); } }

        .leaderboard { display: flex; flex-wrap: wrap; gap: 8px; background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 15px; width: 100%; box-sizing: border-box; justify-content: center;}
        .player-badge { background: #edf2f4; border: 1px solid #ccc; padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; }
        .player-badge.active-turn { background: #ffb703; color: #000; border-color: #ffb703; }

        .bingo-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; width: 100%; max-width: 450px; margin: 0 auto; }
        .bingo-cell { background-color: #fff; border: 2px solid #ccc; border-radius: 8px; aspect-ratio: 1 / 1; display: flex; justify-content: center; align-items: center; padding: 2px; font-size: 0.8rem; font-weight: bold; color: #333; cursor: pointer; user-select: none; transition: 0.2s; word-break: break-word; position: relative; overflow: hidden; }
        .bingo-cell.stamped { background-color: #d90429; border-color: #d90429; color: #fff; transform: scale(0.96); }
        .bingo-cell.stamped::before { content: 'â­•'; position: absolute; font-size: 3rem; opacity: 0.2; color: #fff; }

        /* ì‹¤ì‹œê°„ ì±„íŒ…ë°© */
        .chat-container { background: #fff; border: 2px solid #8d99ae; border-radius: 12px; padding: 10px; margin-top: 20px; width: 100%; max-width: 450px; box-sizing: border-box; display: flex; flex-direction: column; }
        .chat-messages { height: 160px; overflow-y: auto; text-align: left; font-size: 0.9rem; margin-bottom: 10px; display: flex; flex-direction: column; gap: 6px; padding-right: 5px; }
        .chat-msg { background: #f1f3f5; padding: 6px 10px; border-radius: 12px; width: fit-content; max-width: 85%; word-break: break-word; }
        .chat-msg.mine { background: #d90429; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-msg.system { background: transparent; color: #888; font-size: 0.8rem; text-align: center; align-self: center; }
        .chat-sender { font-size: 0.75rem; color: #666; margin-bottom: 2px; margin-left: 2px; }
        .chat-input-row { display: flex; gap: 5px; }
        .chat-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 0.95rem; }
        
        /* ìš°ìŠ¹ì ë°œí‘œ */
        #winnerOverlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(217, 4, 41, 0.95); color: white; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 30px; z-index: 10; }
        .winner-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; width: 90%; max-width: 400px; margin-top: 20px; }
        .w-cell { background: #fff; color: #333; aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; border-radius: 6px; }
        .w-cell.stamped { background: #ffb703; color: #000; border: 2px solid #fff; }

        @media (max-width: 500px) { .setup-input, .bingo-cell { font-size: 0.65rem; } .broadcaster { font-size: 1rem; } }
    </style>
</head>
<body>

<div class="container" id="loginScreen">
    <h1 style="color: #d90429; font-size: 2.2rem; margin-bottom: 5px;">ğŸ”¥ í„´ì œ í’€íŒŒí‹° ë¹™ê³ </h1>
    <p style="color:#666; font-weight: bold;">ë¹¨ë¦¬ ì‘ì„±í• ìˆ˜ë¡ ë¨¼ì € ë‹¨ì–´ë¥¼ ë¶€ë¦…ë‹ˆë‹¤!</p>
    
    <div style="background: #2b2d42; color: #fff; padding: 15px; border-radius: 12px; margin: 20px 0; width: 90%;">
        ì£¼ì œ: <span id="loginSubjectText" style="color: #ffb703;">ë¡œë”© ì¤‘...</span>
    </div>
    <button class="btn-secondary" style="margin-bottom: 25px;" onclick="pickRandomTopic()">ğŸ² ëœë¤ ì£¼ì œ ë½‘ê¸°</button>

    <input type="text" id="playerName" class="login-input" placeholder="ë‹‰ë„¤ì„ ì…ë ¥ (ì˜ˆ: í™ê¸¸ë™)" required autocomplete="off" onkeypress="if(event.key==='Enter') enterSetup()">
    <button class="btn-primary" onclick="enterSetup()">ì…ì¥í•˜ì—¬ ë¹™ê³ íŒ ë§Œë“¤ê¸°</button>
</div>

<div class="container" id="setupScreen">
    <h2 style="color: #d90429; margin-bottom: 5px;">ğŸ“ ë¹™ê³ íŒ 25ì¹¸ ì±„ìš°ê¸°</h2>
    <p style="color: #555; font-weight: bold;">ì£¼ì œ: <span id="setupSubjectText" style="color: #d90429;"></span></p>
    
    <div class="setup-grid" id="setupGrid"></div>
    
    <button class="btn-primary" style="width: 100%; max-width: 450px;" onclick="submitBoard()">ì‘ì„± ì™„ë£Œ (ëŒ€ê¸°ì‹¤ë¡œ ì´ë™)</button>
    <button onclick="fillTestNumbers()" style="margin-top: 15px; background: transparent; border: none; color: #aaa; text-decoration: underline; cursor: pointer;">(í…ŒìŠ¤íŠ¸ìš© ìë™ ì±„ìš°ê¸°)</button>
</div>

<div class="container" id="waitingScreen">
    <h2 style="color: #d90429; margin-bottom: 10px;">â³ ëŒ€ê¸°ì‹¤ (ëª¨ì§‘ ì¤‘)</h2>
    <p style="font-size: 0.9rem; color: #666; margin-bottom: 20px;">ëª¨ë‘ê°€ ì™„ë£Œí•˜ë©´ ì•„ë˜ ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!<br>(ì™„ë£Œ ìˆœì„œëŒ€ë¡œ í„´ì´ ëŒì•„ê°‘ë‹ˆë‹¤)</p>
    
    <div class="wait-list" id="readyPlayerList">
        </div>

    <button class="btn-primary" style="background: #ffb703; color: #000; font-size: 1.3rem; padding: 15px 30px;" onclick="startGame()">â–¶ï¸ ì „ì› ì¤€ë¹„ì™„ë£Œ! ê²Œì„ ì‹œì‘</button>
</div>

<div class="container" id="mainBoard">
    
    <div id="winnerOverlay">
        <h1 style="font-size: 2.5rem; margin-bottom: 10px;">ğŸ‰ <span id="winnerNameDisplay">ëˆ„êµ°ê°€</span> ìš°ìŠ¹! ğŸ‰</h1>
        <div class="winner-grid" id="winnerGrid"></div>
        <button class="btn-secondary" style="margin-top: 25px; background: #2b2d42; padding: 12px 20px;" onclick="resetAllGame()">íŒ ì—ê³  ìƒˆ ê²Œì„ ì‹œì‘</button>
    </div>

    <div id="turnAlertBox" class="turn-alert">ë¡œë”© ì¤‘...</div>
    <div class="broadcaster" id="broadcasterDisplay">ğŸ“¢ ì•„ì§ ë¶ˆë¦° ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>

    <div class="leaderboard" id="playerList"></div>
    
    <div style="display:flex; justify-content: space-between; align-items: center; width: 100%; max-width: 450px; margin: 0 auto 10px auto;">
        <span style="font-size: 1.2rem; font-weight: bold; color: #d90429;" id="myStatusText">ë‚´ ë¹™ê³ : 0ì¤„</span>
        <button class="btn-secondary" onclick="resetAllGame()" style="font-size:0.8rem; padding: 6px 10px;">ì „ì²´ ì´ˆê¸°í™”</button>
    </div>

    <div class="bingo-grid" id="bingoGrid"></div>

    <div class="chat-container">
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-row">
            <input type="text" id="chatInput" class="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥..." onkeypress="if(event.key==='Enter') sendChat()">
            <button class="btn-primary" style="padding: 10px 15px;" onclick="sendChat()">ì „ì†¡</button>
        </div>
    </div>
</div>

<script>
    // 1. Firebase ì„¤ì •
    const firebaseConfig = {
        apiKey: "AIzaSyBZmxJUr5oaZttF7oIYJSEBb5RgjVQjInY",
        authDomain: "cofirm-board.firebaseapp.com",
        databaseURL: "https://cofirm-board-default-rtdb.firebaseio.com", 
        projectId: "cofirm-board",
        storageBucket: "cofirm-board.firebasestorage.app",
        messagingSenderId: "367825644618",
        appId: "1:367825644618:web:3f236c72c07d5347878ab3"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const gameRef = db.ref('turn_bingo'); 
    const chatRef = db.ref('turn_bingo/chat');
    
    let myName = ""; 
    let myBoardRef = null;
    let turnOrderList = [];
    let currentTurnPlayer = "";

    // ğŸ’¡ ì£¼ì œ ë£°ë ›
    const topicList = ["ì˜í™” ì œëª©", "ë‚˜ë¼ ì´ë¦„", "ë“œë¼ë§ˆ ì œëª©", "ë™ë¬¼ ì´ë¦„", "ê³¼ì¼/ì±„ì†Œ", "ì—°ì˜ˆì¸", "ìŒì‹", "ì•„ì´ìŠ¤í¬ë¦¼", "ê²Œì„ ì´ë¦„", "íšŒì‚¬ ì‚¬ëŒ ì´ë¦„"];
    function pickRandomTopic() {
        gameRef.child('subject').set(topicList[Math.floor(Math.random() * topicList.length)]);
    }
    gameRef.child('subject').on('value', (snap) => {
        const sub = snap.val() || "ììœ  ì£¼ì œ";
        document.getElementById('loginSubjectText').innerText = sub;
        document.getElementById('setupSubjectText').innerText = sub;
    });

    // 2. ì‘ì„± í™”ë©´ ì§„ì…
    function enterSetup() {
        const val = document.getElementById('playerName').value.trim();
        if(!val) { alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”!"); return; }
        myName = val;
        myBoardRef = gameRef.child('players').child(myName);

        myBoardRef.once('value', (snap) => {
            const data = snap.val();
            if (data && data.ready) {
                // ì´ë¯¸ ì¤€ë¹„ ì™„ë£Œë©´ ë©”ì¸ì´ë‚˜ ëŒ€ê¸°ì‹¤ë¡œ (ìƒíƒœì— ë”°ë¼ ë‹¤ë¦„)
                gameRef.child('state').once('value', stateSnap => {
                    if(stateSnap.val() && stateSnap.val().isStarted) {
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('mainBoard').style.display = 'flex';
                        startMainGameListeners();
                    } else {
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('waitingScreen').style.display = 'flex';
                        listenToWaitingRoom();
                    }
                });
            } else {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('setupScreen').style.display = 'flex';
                
                const grid = document.getElementById('setupGrid');
                grid.innerHTML = '';
                for(let i=0; i<25; i++) {
                    const input = document.createElement('input');
                    input.type = 'text'; input.className = 'setup-input'; input.id = `input_cell_${i}`;
                    input.onkeypress = (e) => { if(e.key === 'Enter') { const n = document.getElementById(`input_cell_${i+1}`); if(n) n.focus(); } };
                    grid.appendChild(input);
                }
            }
        });
    }

    // 3. ë¹™ê³ íŒ ì œì¶œ ë° ëŒ€ê¸°ì‹¤ ì´ë™
    function submitBoard() {
        const newBoard = {};
        for(let i=0; i<25; i++) {
            const val = document.getElementById(`input_cell_${i}`).value.trim();
            if(!val) { alert(`25ì¹¸ì„ ëª¨ë‘ ì±„ì›Œì£¼ì„¸ìš”! (ë¹ˆ ì¹¸: ${i+1}ë²ˆì§¸)`); return; }
            newBoard[i] = { text: val, stamped: false };
        }

        // ì„œë²„ì‹œê°„ìœ¼ë¡œ ì¤€ë¹„ ì™„ë£Œ ê¸°ë¡ (ì´ ìˆœì„œëŒ€ë¡œ í„´ ì •í•¨)
        myBoardRef.set({ 
            ready: true, 
            readyAt: firebase.database.ServerValue.TIMESTAMP, 
            lines: 0, 
            board: newBoard 
        });

        chatRef.push({ type: 'system', msg: `[${myName}]ë‹˜ì´ ë¹™ê³ íŒ ì‘ì„±ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!` });

        document.getElementById('setupScreen').style.display = 'none';
        document.getElementById('waitingScreen').style.display = 'flex';
        listenToWaitingRoom();
    }

    // 4. ëŒ€ê¸°ì‹¤ í˜„í™© ê°ì‹œ ë° ê²Œì„ ì‹œì‘
    function listenToWaitingRoom() {
        gameRef.child('players').on('value', (snap) => {
            const players = snap.val();
            const listObj = document.getElementById('readyPlayerList');
            if(!listObj) return;
            
            listObj.innerHTML = '';
            let sortedPlayers = [];
            for(let key in players) {
                if(players[key].ready) {
                    sortedPlayers.push({ name: key, time: players[key].readyAt });
                }
            }
            // ë¹¨ë¦¬ ì¤€ë¹„í•œ ìˆœìœ¼ë¡œ ì •ë ¬
            sortedPlayers.sort((a,b) => a.time - b.time);
            
            sortedPlayers.forEach((p, idx) => {
                const div = document.createElement('div');
                div.className = 'wait-item';
                div.innerText = `${idx + 1}ë²ˆì§¸ í„´: ${p.name}`;
                listObj.appendChild(div);
            });
        });

        // ê²Œì„ ì‹œì‘ ê°ì§€
        gameRef.child('state').on('value', (snap) => {
            if(snap.val() && snap.val().isStarted) {
                document.getElementById('waitingScreen').style.display = 'none';
                document.getElementById('mainBoard').style.display = 'flex';
                gameRef.child('players').off(); // ëŒ€ê¸°ì‹¤ ë¦¬ìŠ¤ë„ˆ ì¢…ë£Œ
                startMainGameListeners();
            }
        });
    }

    function startGame() {
        gameRef.child('players').once('value', (snap) => {
            const players = snap.val();
            let sortedNames = [];
            for(let key in players) { if(players[key].ready) sortedNames.push({ name: key, time: players[key].readyAt }); }
            sortedNames.sort((a,b) => a.time - b.time);
            const turnOrder = sortedNames.map(p => p.name);

            if(turnOrder.length < 2) {
                if(!confirm("í˜¼ìì„œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ìµœì†Œ 2ëª… ê¶Œì¥)")) return;
            }

            gameRef.child('state').set({
                isStarted: true,
                turnOrder: turnOrder,
                turnIndex: 0,
                lastCalledWord: "ì•„ì§ ì—†ìŒ",
                lastCaller: "ì•Œë¦¼"
            });
            
            chatRef.push({ type: 'system', msg: `ğŸ”¥ ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! ì²« í„´ì€ [${turnOrder[0]}]ë‹˜ì…ë‹ˆë‹¤.` });
        });
    }

    // 5. ë©”ì¸ ê²Œì„ ë¡œì§
    function startMainGameListeners() {
        // [ë‚´ ë¹™ê³ íŒ ë Œë”ë§ & í´ë¦­ ì²˜ë¦¬]
        myBoardRef.child('board').on('value', (snapshot) => {
            const data = snapshot.val();
            if(!data) return;

            const gridElement = document.getElementById('bingoGrid');
            gridElement.innerHTML = '';
            let cellArray = [];

            for (let i = 0; i < 25; i++) {
                const cellData = data[i];
                cellArray.push(cellData);
                const cell = document.createElement('div');
                cell.className = cellData.stamped ? 'bingo-cell stamped' : 'bingo-cell';
                cell.innerText = cellData.text;
                
                cell.onclick = () => {
                    const isNowStamped = !cellData.stamped;
                    // ë„ì¥ ì°ê¸° (ë¬´ì¡°ê±´ ë‚´ íŒì—ëŠ” ì°í˜)
                    myBoardRef.child('board').child(i).update({ stamped: isNowStamped });

                    // ğŸ”¥ ë‚´ ì°¨ë¡€ì¸ë° 'ìƒˆë¡œìš´ ë‹¨ì–´'ë¥¼ ì°ì—ˆì„ ë•Œë§Œ í™•ì„±ê¸° ë°©ì†¡ + í„´ ë„˜ê¹€!
                    if (currentTurnPlayer === myName && isNowStamped) {
                        if(confirm(`[ ${cellData.text} ](ì„)ë¥¼ ì™¸ì¹˜ì‹œê² ìŠµë‹ˆê¹Œ? í„´ì´ ë„˜ì–´ê°‘ë‹ˆë‹¤.`)) {
                            // í™•ì„±ê¸° ì „ì†¡ ë° í„´ ì¦ê°€
                            gameRef.child('state').once('value', snap => {
                                const st = snap.val();
                                const nextIndex = (st.turnIndex + 1) % st.turnOrder.length;
                                gameRef.child('state').update({
                                    lastCalledWord: cellData.text,
                                    lastCaller: myName,
                                    turnIndex: nextIndex
                                });
                            });
                        } else {
                            // ì·¨ì†Œí•˜ë©´ ì°ì—ˆë˜ ë„ì¥ ë‹¤ì‹œ ì›ìƒë³µêµ¬
                            myBoardRef.child('board').child(i).update({ stamped: false });
                        }
                    }
                };
                gridElement.appendChild(cell);
            }
            checkMyBingo(cellArray);
        });

        // [í„´ ë° ìƒíƒœ ê°ì‹œ]
        gameRef.child('state').on('value', (snapshot) => {
            const state = snapshot.val();
            if(!state) return;

            turnOrderList = state.turnOrder || [];
            currentTurnPlayer = turnOrderList[state.turnIndex];

            // UI ì—…ë°ì´íŠ¸: ì°¨ë¡€ ì•Œë¦¼
            const alertBox = document.getElementById('turnAlertBox');
            if (currentTurnPlayer === myName) {
                alertBox.className = "turn-alert my-turn";
                alertBox.innerText = `ğŸš¨ ë‚´ ì°¨ë¡€ì…ë‹ˆë‹¤! ë¶€ë¥¼ ë‹¨ì–´ë¥¼ í´ë¦­í•˜ì„¸ìš”! ğŸš¨`;
                if(navigator.vibrate) navigator.vibrate(200); // í° ì§„ë™ í”¼ë“œë°±
            } else {
                alertBox.className = "turn-alert";
                alertBox.innerText = `í˜„ì¬ ì°¨ë¡€: [ ${currentTurnPlayer} ]ë‹˜ (ê³ ë¯¼ ì¤‘...)`;
            }

            // UI ì—…ë°ì´íŠ¸: í™•ì„±ê¸° (ë°©ê¸ˆ ë¶€ë¥¸ ë‹¨ì–´)
            if (state.lastCalledWord !== "ì•„ì§ ì—†ìŒ") {
                document.getElementById('broadcasterDisplay').innerHTML = `ğŸ“¢ <b>${state.lastCaller}</b>ë‹˜ì˜ ì™¸ì¹¨!<br><span style="color:#d90429; font-size:1.5rem;">[ ${state.lastCalledWord} ]</span>`;
            }

            // ìš°ìŠ¹ì ì²´í¬
            if (state.isGameOver) {
                document.getElementById('winnerOverlay').style.display = 'flex';
                document.getElementById('winnerNameDisplay').innerText = state.winnerName;
                gameRef.child('players').child(state.winnerName).child('board').once('value', (bSnap) => {
                    const wBoard = bSnap.val();
                    const wGrid = document.getElementById('winnerGrid');
                    wGrid.innerHTML = '';
                    if(wBoard) {
                        for(let i=0; i<25; i++) {
                            const d = document.createElement('div');
                            d.className = wBoard[i].stamped ? 'w-cell stamped' : 'w-cell';
                            d.innerText = wBoard[i].text;
                            wGrid.appendChild(d);
                        }
                    }
                });
            }
        });

        // [ë¦¬ë”ë³´ë“œ ë Œë”ë§]
        gameRef.child('players').on('value', (snapshot) => {
            const players = snapshot.val();
            const listObj = document.getElementById('playerList');
            listObj.innerHTML = '';
            
            // turnOrderList ìˆœì„œëŒ€ë¡œ ë Œë”ë§
            turnOrderList.forEach(pName => {
                if(!players[pName]) return;
                const lines = players[pName].lines || 0;
                const span = document.createElement('span');
                
                span.className = (pName === currentTurnPlayer) ? "player-badge active-turn" : "player-badge";
                span.innerText = `${pName}: ${lines}ì¤„`;
                listObj.appendChild(span);
            });
        });

        // [ì±„íŒ… ì‹œìŠ¤í…œ ì‹œì‘]
        startChat();
    }

    // 6. ë¹™ê³  ê³„ì‚°ê¸°
    function checkMyBingo(cells) {
        if(cells.length < 25) return;
        let lines = 0;
        for (let r = 0; r < 5; r++) { if (cells[r*5].stamped && cells[r*5+1].stamped && cells[r*5+2].stamped && cells[r*5+3].stamped && cells[r*5+4].stamped) lines++; }
        for (let c = 0; c < 5; c++) { if (cells[c].stamped && cells[c+5].stamped && cells[c+10].stamped && cells[c+15].stamped && cells[c+20].stamped) lines++; }
        if (cells[0].stamped && cells[6].stamped && cells[12].stamped && cells[18].stamped && cells[24].stamped) lines++;
        if (cells[4].stamped && cells[8].stamped && cells[12].stamped && cells[16].stamped && cells[20].stamped) lines++;

        document.getElementById('myStatusText').innerText = `ë‚´ ë¹™ê³ : ${lines}ì¤„`;
        myBoardRef.update({ lines: lines });

        if (lines >= 5) {
            gameRef.child('state').once('value', snap => {
                const st = snap.val();
                if(!st || !st.isGameOver) {
                    gameRef.child('state').update({ isGameOver: true, winnerName: myName });
                    chatRef.push({ type: 'system', msg: `ğŸ‰ğŸ‰ [${myName}]ë‹˜ì´ 5ë¹™ê³ ë¥¼ ë‹¬ì„±í•˜ì—¬ ìš°ìŠ¹í–ˆìŠµë‹ˆë‹¤! ğŸ‰ğŸ‰` });
                }
            });
        }
    }

    // 7. ì‹¤ì‹œê°„ ì±„íŒ… ë¡œì§
    function startChat() {
        const chatBox = document.getElementById('chatMessages');
        chatRef.on('child_added', (snap) => {
            const data = snap.val();
            const div = document.createElement('div');
            
            if(data.type === 'system') {
                div.className = 'chat-msg system';
                div.innerText = data.msg;
            } else {
                div.className = data.sender === myName ? 'chat-msg mine' : 'chat-msg';
                if(data.sender !== myName) {
                    const nameLabel = document.createElement('div');
                    nameLabel.className = 'chat-sender';
                    nameLabel.innerText = data.sender;
                    div.appendChild(nameLabel);
                }
                const msgSpan = document.createElement('span');
                msgSpan.innerText = data.msg;
                div.appendChild(msgSpan);
            }
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight; // ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ
        });
    }

    window.sendChat = function() {
        const input = document.getElementById('chatInput');
        const txt = input.value.trim();
        if(txt) {
            chatRef.push({ type: 'user', sender: myName, msg: txt });
            input.value = '';
        }
    }

    // 8. ì´ˆê¸°í™” ë° í…ŒìŠ¤íŠ¸ ì±„ìš°ê¸°
    window.resetAllGame = function() {
        if(!confirm("ì§„ì§œë¡œ ê²Œì„ì„ í­íŒŒí•˜ê³  ìƒˆë¡œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ëŒ€ê¸°ì‹¤ë¶€í„° ì‹œì‘ë©ë‹ˆë‹¤)")) return;
        gameRef.remove().then(() => {
            alert("ì´ˆê¸°í™” ì™„ë£Œ! F5ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
            location.reload();
        });
    }

    function fillTestNumbers() {
        let nums = Array.from({length: 25}, (_, i) => "í…ŒìŠ¤íŠ¸_" + (i + 1));
        nums.sort(() => Math.random() - 0.5);
        for(let i=0; i<25; i++) { document.getElementById(`input_cell_${i}`).value = nums[i]; }
    }
</script>

</body>
</html>